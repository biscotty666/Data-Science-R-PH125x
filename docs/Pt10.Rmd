---
title: "10 Data visualization in practice"
output:
  html_document:
    df_print: paged
    css: "style.css"
    toc: true
---

[Book](http://rafalab.dfci.harvard.edu/dsbook/r-basics.html)

R commands in this chapter

|[`facet_grid`](#facet_grid)|
[`facet_wrap`](#facet_wrap)|
[`geomtextpath`](#geomtextpath)|


# 10.1 Case study: new insights on poverty

Hans Rosling^[https://en.wikipedia.org/wiki/Hans_Rosling] was the co-founder of the Gapminder Foundation^[http://www.gapminder.org/], an organization dedicated to educating the public by using data to dispel common myths about the so-called developing world. The organization uses data to show how actual trends in health and economics contradict the narratives that emanate from sensationalist media coverage of catastrophes, tragedies, and other unfortunate events. As stated in the Gapminder Foundation's website:

>>> Journalists and lobbyists tell dramatic stories. That’s their job. They tell stories about extraordinary events and unusual people. The piles of dramatic stories pile up in peoples' minds into an over-dramatic worldview and strong negative stress feelings: "The world is getting worse!", "It’s we vs. them!”, “Other people are strange!", "The population just keeps growing!" and "Nobody cares!"

Hans Rosling conveyed actual data-based trends in a dramatic way of his own, using effective data visualization. This section is based on two talks that exemplify this approach to education: [New Insights on Poverty]^[https://www.ted.com/talks/hans_rosling_reveals_new_insights_on_poverty?language=en] and The Best Stats You've Ever Seen^[https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen]. Specifically, in this section, we use data to attempt to answer the following two questions:

1. Is it a fair characterization of today's world to say it is divided into western rich nations and the developing world in Africa, Asia, and Latin America? 
2. Has income inequality across countries worsened during the last 40 years? 

To answer these questions, we will be using the `gapminder` dataset provided in __dslabs__. This dataset was created using a number of spreadsheets available from the Gapminder Foundation. You can access the table like this:

```{r}
# install.packages("tidyverse")
# install.packages("dslabs")
library(tidyverse)
library(dslabs)
data(gapminder)
gapminder |> 
  as_tibble() |>
  head()
```

## 10.1.1 Hans Rosling's quiz

As done in the *New Insights on Poverty* video, we start by testing our knowledge regarding differences in child mortality across different countries. For each of the six pairs of countries below, <span class="yellow">which country do you think had the highest child mortality rates in 2015?</span> Which pairs do you think are most similar?

1. Sri Lanka or Turkey
2. Poland or South Korea
3. Malaysia or Russia
4. Pakistan or Vietnam
5. Thailand or South Africa

When answering these questions without data, the non-European countries are typically picked as having higher child mortality rates: Sri Lanka over Turkey, South Korea over Poland, and Malaysia over Russia. It is also common to assume that countries considered to be part of the developing world: Pakistan, Vietnam, Thailand, and South Africa, have similarly high mortality rates.

To answer these questions with data, we can use **dplyr**. For example, for the first comparison we see that:
```{r}
gapminder |>
  filter(year == 2015 & country %in% c("Sri Lanka", "Turkey")) |>
  select(country, infant_mortality)
```
```{r}
comp_table <-
  tibble(comparison = rep(1:5, each = 2),
         country = c("Sri Lanka", "Turkey", "Poland", "South Korea", "Malaysia", "Russia", "Pakistan","Vietnam","Thailand","South Africa"))

tmp <- 
  gapminder |>
  filter(year == 2015) |>
  select(country, infant_mortality) |>
  mutate(country = as.character(country))

tab <- 
  inner_join(comp_table, tmp, by = "country") |>
  select(-comparison)

tmp <- 
  bind_cols(slice(tab, seq(1, 9, 2)),
            slice(tab, seq(2, 10, 2)))
names(tmp) <- c("country", "infant mortality", "country", "infant mortality")

if(knitr::is_html_output()){
  knitr::kable(tmp, "html") |>
    kableExtra::kable_styling(bootstrap_options = "striped", full_width = FALSE)
} else{
  knitr::kable(tmp, "latex", booktabs = TRUE) |>
    kableExtra::kable_styling(font_size = 8)
}
```

We see that the European countries on this list have higher child mortality rates: Poland has a higher rate than South Korea, and Russia has a higher rate than Malaysia. We also see that Pakistan has a much higher rate than Vietnam, and South Africa has a much higher rate than Thailand. It turns out that when Hans Rosling gave this quiz to educated groups of people, the average score was less than 2.5 out of 5, worse than what they would have obtained had they guessed randomly. This implies that more than ignorant, we are misinformed. In this chapter we see how data visualization helps inform us.

# 10.2 Scatterplots

The reason for this stems from the preconceived notion that the world is divided into two groups: the western world (Western Europe and North America), characterized by long life spans and small families, versus the developing world (Africa, Asia, and Latin America) characterized by short life spans and large families. <span class="yellow">But do the data support this dichotomous view?</span>

In order to analyze this world view, our first plot is a scatterplot of life expectancy versus fertility rates (average number of children per woman). We start by looking at data from about 50 years ago, when perhaps this view was first cemented in our minds.

```{r}
filter(gapminder, year == 1962) |>
  ggplot(aes(fertility, life_expectancy)) +
  geom_point()
```

Most points fall into two distinct categories:

1. Life expectancy around 70 years and 3 or fewer children per family.
2. Life expectancy lower than 65 years and more than 5 children per family.

To confirm that indeed these countries are from the regions we expect, we can use color to represent continent.

```{r}
filter(gapminder, year == 1962) |>
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point()
```

<span class="yellow">In 1962, “the West versus developing world” view was grounded in some reality. Is this still the case 50 years later?</span>

# 10.3 Faceting

We could easily plot the 2012 data in the same way we did for 1962. To make comparisons, however, side by side plots are preferable. In **ggplot2**, we can achieve this by faceting variables: we stratify the data by some variable and make the same plot for each strata.

To achieve faceting, we add a layer with the function <span id="facet_grid">**`facet_grid`**</span>, which automatically separates the plots. This function lets you facet by up to two variables using columns to represent one variable and rows to represent the other. The function expects the row and column variables to be separated by a ~. Here is an example of a scatterplot with facet_grid added as the last layer:

```{r}
gapminder |>
  filter(year %in% c(1962, 2012)) |>
  ggplot(aes(fertility, life_expectancy, col = continent)) +
  geom_point() +
  facet_grid(year ~ continent)
```

We see a plot for each continent/year pair. However, this is just an example and more than what we want, which is simply to compare 1962 and 2012. <span class="yellow">In this case, there is just one variable and we use . to let facet know that we are not using one of the variables:</span>

```{r}
gapminder |>
  filter(year %in% c(1962, 2012)) |>
  ggplot(aes(fertility, life_expectancy, col = continent)) +
  geom_point() +
  facet_grid(. ~ year)
```

This plot clearly shows that the majority of countries have moved from the developing world cluster to the western world one. In 2012, the western versus developing world view no longer makes sense. This is particularly clear when comparing Europe to Asia, the latter of which includes several countries that have made great improvements.

<span id="facet_wrap"></span>

## 10.3.1 `facet_wrap`

To explore how this transformation happened through the years, we can make the plot for several years. For example, we can add 1970, 1980, 1990, and 2000. If we do this, we will not want all the plots on the same row, the default behavior of `facet_grid`, since they will become too thin to show the data. Instead, we will want to use multiple rows and columns. <span class="yellow">The function facet_wrap permits us to do this by automatically wrapping the series of plots so that each display has viewable dimensions</span>:
```{r}
years <- c(1962, 1980, 1990, 2000, 2012)
continents <- c("Europe", "Asia")
gapminder |>
  filter(year %in% years & continent %in% continents) |>
  ggplot(aes(fertility, life_expectancy, col = continent)) +
  geom_point() +
  facet_wrap(~year)
```

This plot clearly shows how most Asian countries have improved at a much faster rate than European ones.

## 10.3.2 Fixed scales for better comparisons

The default choice of the range of the axes is important. When not using facet, this range is determined by the data shown in the plot. <span class="yellow">When using facet, this range is determined by the data shown in all plots and therefore kept fixed across plots.</span> This makes comparisons across plots much easier. For example, in the above plot, we can see that life expectancy has increased and the fertility has decreased across most countries. We see this because the cloud of points moves. This is not the case if we adjust the scales:

```{r}
gapminder |>
  filter(year %in% c(1962, 2012)) |>
  ggplot(aes(fertility, life_expectancy, col = continent)) +
  geom_point() +
  facet_wrap(. ~ year, scales = "free")
```

<span class="yellow">In the plot above, we have to pay special attention to the range to notice that the plot on the right has a larger life expectancy.</span>

# 10.4 Time series plots

The visualizations above effectively illustrate that data no longer supports the western versus developing world view. Once we see these plots, new questions emerge. For example, <span class="yellow">which countries are improving more and which ones less? Was the improvement constant during the last 50 years or was it more accelerated during certain periods?</span> For a closer look that may help answer these questions, we introduce time series plots.

Time series plots have time in the x-axis and an outcome or measurement of interest on the y-axis. For example, here is a trend plot of United States fertility rates:
```{r}
gapminder |>
  filter(country == "United States") |>
  ggplot(aes(year, fertility)) +
  geom_point()
```

We see that the trend is not linear at all. Instead there is sharp drop during the 1960s and 1970s to below 2. Then the trend comes back to 2 and stabilizes during the 1990s.

When the points are regularly and densely spaced, as they are here, we create curves by joining the points with lines, to convey that these data are from a single series, here a country. To do this, we use the `geom_line` function instead of `geom_point`.

```{r}
gapminder |>
  filter(country == "United States") |>
  ggplot(aes(year, fertility)) +
  geom_line()
```

This is particularly helpful when we look at two countries. <span class="yellow">If we subset the data</span> to include two countries, one from Europe and one from Asia, then adapt the code above:

```{r}
countries <- c("South Korea", "Germany")

gapminder |>
  filter(country %in% countries) |>
  ggplot(aes(year, fertility)) +
  geom_line()
```

Unfortunately, this is **not** the plot that we want. Rather than a line for each country, <span class="yellow">the points for both countries are joined</span>. This is actually expected since we have not told ggplot anything about wanting two separate lines. To let ggplot know that there are two curves that need to be made separately, we <span class="yellow">assign each point to a group,</span> one for each country:

```{r}
countries <- c("South Korea", "Germany")

gapminder |>
  filter(country %in% countries & !is.na(fertility)) |>
  ggplot(aes(year, fertility, group = country)) +
  geom_line()
```
```{r}
countries <- c("South Korea", "Germany")

gapminder |>
  filter(country %in% countries & !is.na(fertility)) |>
  ggplot(aes(year, fertility, col = country)) +
  geom_line()
```

The plot clearly shows how South Korea’s fertility rate dropped drastically during the 1960s and 1970s, and by 1990 had a similar rate to that of Germany.

## 10.4.1 Labels instead of legends

For trend plots we recommend labeling the lines rather than using legends since the viewer can quickly see which line is which country. This suggestion actually applies to most plots: <span class="yellow">labeling is usually preferred over legends.</span>

We demonstrate how we can do this using <span id="geomtextpath">**`geomtextpath`**</span> from the **geomtextpath** package. We define a data table with the label locations and then use a second mapping just for these labels:

```{r}
# install.packages("geomtextpath")
library(geomtextpath)

countries <- c("South Korea", "Germany")

gapminder |>
  filter(country %in% countries & !is.na(fertility)) |>
  ggplot(aes(year, 
             life_expectancy, 
             col = country,
             label = country)) +
  geom_textpath() +
  theme(legend.position = "none")
```

The plot clearly shows how an improvement in life expectancy followed the drops in fertility rates. In 1960, Germans lived 15 years longer than South Koreans, although by 2010 the gap is completely closed. It exemplifies the improvement that many non-western countries have achieved in the last 40 years.

# 10.5 Data transformations

We now shift our attention to the second question related to the commonly held notion that wealth distribution across the world has become worse during the last decades. When general audiences are asked if poor countries have become poorer and rich countries become richer, the majority answers yes. By using stratification, histograms, smooth densities, and boxplots, we will be able to understand if this is in fact the case. First we learn how transformations can sometimes help provide more informative summaries and plots.

The `gapminder` data table includes a column with the countries’ gross domestic product (GDP). GDP measures the market value of goods and services produced by a country in a year. The GDP per person is often used as a rough summary of a country’s wealth. Here we divide this quantity by 365 to obtain the more interpretable measure dollars per day. Using current US dollars as a unit, a person surviving on an income of less than $2 a day is defined to be living in absolute poverty. We add this variable to the data table:
```{r}
gapminder <- 
  gapminder |>
  mutate(dollars_per_day = gdp / population / 362)
head(gapminder)
```

The GDP values are adjusted for inflation and represent current US dollars, so these values are meant to be comparable across the years. Of course, these are country averages and within each country there is much variability. <span class="yellow">All the graphs and insights described below relate to country averages and not to individuals.</span>

## 10.5.1 Log transformations

Here is a histogram of per day incomes from 1970:

```{r}
past_year <- 1970
gapminder |>
  filter(year == past_year & !is.na(gdp)) |>
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black")
```

In this plot, we see that for the majority of countries, averages are below $10 a day. However, the majority of the x-axis is dedicated to the 35 countries with averages above $10. So the plot is not very informative about countries with values below $10 a day.

<span class="yellow">It might be more informative to quickly be able to see how many countries have average daily incomes of about $1 (extremely poor), $2 (very poor), $4 (poor), $8 (middle), $16 (well off), $32 (rich), $64 (very rich) per day. These changes are multiplicative and log transformations convert multiplicative changes into additive ones: when using base 2, a doubling of a value turns into an increase by 1.</span>

Here is the distribution if we apply a log base 2 transform:

```{r}
past_year <- 1970
gapminder |>
  filter(year == past_year & !is.na(gdp)) |>
  ggplot(aes(log2(dollars_per_day))) +
  geom_histogram(binwidth = 1, color = "black")
```

In a way this provides a *close-up* of the mid to lower income countries.

## 10.5.2 Which base?

In the case above, we used base 2 in the log transformations. Other common choices are base $e$ and base 10.

<span class="yellow">In general, we do not recommend using the natural log for data exploration and visualization.</span> This is because while $2^2,2^3,2^4,\dots$ or $10^2,10^3,\dots$ are easy to compute in our heads, the same is not true for $e^2,e^3,\dots$, so the scale is not intuitive or easy to interpret.

In the dollars per day example, we used base 2 instead of base 10 because the resulting range is easier to interpret. The range of the values being plotted is 0.327, 48.885.

In base 10, this turns into a range that includes very few integers: just 0 and 1. With base two, our range includes -2, -1, 0, 1, 2, 3, 4, and 5. It is easier to compute $2^x$ and $10^x$ when $x$ is an integer and between -10 and 10, so we prefer to have smaller integers in the scale. Another consequence of a limited range is that choosing the binwidth is more challenging. <span class="yellow">With log base 2, we know that a binwidth of 1 will translate to a bin with range $x$ to $2^x$.</span>

For an example in which base 10 makes more sense, consider population sizes. A log base 10 is preferable since the range for these is:

```{r}
gapminder |>
  filter(year == past_year) |>
  summarise(min = min(population), max = max(population))
```
```{r}
gapminder |> 
  filter(year == past_year) |>
  ggplot(aes(log10(population))) +
  geom_histogram(binwidth = 0.5, color = "black")
```

In the above, we quickly see that country populations range between ten thousand and ten billion.

## 10.5.3 Transform the values of the scale?

There are two ways we can use log transformations in plots. <span class="yellow">We can log the values before plotting them or use log scales in the axes. Both approaches are useful and have different strengths.</span> If we log the data, we can more easily interpret intermediate values in the scale. For example, if we see:
```
----1----x----2--------3----
```
for log transformed data, we know that the value of $x$ is about 1.5. If the scales are logged:
```
----10---x---100------1000---
```
then, to determine `x`, we need to compute $10^{1.5}$, which is not easy to do in our heads. The advantage of using logged scales is that we see the original values on the axes. However, the advantage of showing logged scales is that the original values are displayed in the plot, which are easier to interpret. For example, we would see “32 dollars a day” instead of “5 log base 2 dollars a day”.

<span class="yellow">As we learned earlier, if we want to scale the axis with logs, we can use the `scale_x_continuous` function. Instead of logging the values first, we apply this layer:</span>

```{r}
gapminder |>
  filter(year == past_year & !is.na(gdp)) |>
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_x_continuous(trans = "log2")
```

Note that the log base 10 transformation has its own function: scale_x_log10(), but currently base 2 does not, although we could easily define our own.

There are other transformations available through the trans argument. As we learn later on, the square root (`sqrt`) transformation is useful when considering counts. The logistic transformation (`logit`) is useful when plotting proportions between 0 and 1. The `reverse` transformation is useful when we want smaller values to be on the right or on top.

# 10.6 Visualizing multimodal distributions




















